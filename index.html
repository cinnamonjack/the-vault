<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAVE A SANDWICH | Music Vault</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --orange: #ff4500;
            --bg: #0a0a0a;
            --card: #1a1a1a;
            --text: #e0e0e0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1100px; margin: 0 auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1 { font-weight: 900; letter-spacing: -1px; margin: 0; color: var(--orange); }

        /* Filter Section Styles */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-box {
            flex-grow: 1;
            padding: 10px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }

        .slider-group { 
            display: flex; 
            align-items: center; 
            gap: 10px;
            min-width: 160px; /* Compressed width */
        }

        .toggle-group { display: flex; align-items: center; gap: 10px; }

        .type-toggle {
            display: flex;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }

        .type-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: bold;
        }

        .type-option.active { background: var(--orange); color: black; }

        .vibe-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }

        .chip {
            padding: 6px 12px;
            background: #333;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .chip.active { background: var(--orange); color: black; }

        /* Table & Badge Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid #333; color: #888; font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 15px 12px; border-bottom: 1px solid #222; vertical-align: middle; }

        .badge-os { background: #006400; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; margin-left: 8px; font-weight: bold; }
        
        .badge-remix { 
            background: #000; 
            color: var(--orange); 
            border: 1px solid var(--orange);
            padding: 2px 6px; 
            border-radius: 3px; 
            font-size: 0.6rem; 
            margin-left: 8px; 
            font-weight: bold; 
        }

        .tag-text { font-size: 0.85rem; color: #aaa; line-height: 1.4; }
        .meta-label { display: block; font-size: 0.7rem; color: #666; margin-top: 4px; }
        .vibe-label { color: var(--orange); font-weight: bold; }

        .play-btn {
            background: var(--orange);
            border: none;
            color: black;
            padding: 8px 16px;
            font-weight: 900;
            cursor: pointer;
            border-radius: 4px;
        }

        #resultCount { font-size: 0.8rem; color: #666; margin-bottom: 10px; }

        /* Audio Player Bar */
        #playerBar {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            background: #111;
            padding: 15px;
            border-top: 2px solid var(--orange);
            display: none;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>HAVE A SANDWICH</h1>
        <div style="text-align: right; font-size: 0.7rem; color: #666;">ONE-STOP SYNC ARCHIVE<br>BY PETE DOWNES</div>
    </header>

    <div class="controls">
        <input type="text" id="musicSearch" class="search-box" placeholder="Search title, vibe, or artist...">
        
        <div class="slider-group">
            <span style="font-size: 0.7rem; font-weight: bold;">MIN SCORE: <span id="scoreVal">10</span></span>
            <input type="range" id="scoreSlider" min="1" max="10" value="10" step="1">
        </div>

        <div class="toggle-group">
            <div class="type-toggle">
                <div class="type-option active" data-type="all">All</div>
                <div class="type-option" data-type="vocal">Vocals</div>
                <div class="type-option" data-type="instrumental">Instrumentals</div>
                <div class="type-option" data-type="remix" style="border-left: 1px solid #444;">Inst. Available</div>
            </div>
        </div>

        <div class="vibe-chips">
            <div class="chip active" data-vibe="all">ALL VIBES</div>
            <div class="chip" data-vibe="Action/Rock">ACTION/ROCK</div>
            <div class="chip" data-vibe="Tension">TENSION</div>
            <div class="chip" data-vibe="Atmospheric">ATMOSPHERIC</div>
            <div class="chip" data-vibe="Positive">POSITIVE</div>
            <div class="chip" data-vibe="Emotive">EMOTIVE</div>
        </div>
    </div>

    <div id="resultCount">Loading catalog...</div>

    <table>
        <thead>
            <tr>
                <th style="width: 40%;">Track Title</th>
                <th style="width: 20%;">Artist</th>
                <th style="width: 30%;">Vibe & Meta</th>
                <th style="width: 10%;">Preview</th>
            </tr>
        </thead>
        <tbody id="vaultBody">
            </tbody>
    </table>
</div>

<div id="playerBar">
    <div id="nowPlaying" style="font-size: 0.8rem; font-weight: bold;"></div>
    <audio id="audioPlayer" controls style="width: 400px;"></audio>
    <button onclick="$('#playerBar').hide()" style="background:none; border:none; color:white; cursor:pointer;">âœ•</button>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_I-vL-Y0V2hJ7o9y0u8Y3u9K79nB_hTz3M0Xy4q9Z9p5o5_7_Y_V-9p/pub?output=csv'; // Update with your actual CSV URL

    let fullCatalog = [];
    let activeThreshold = 10;
    let activeType = "all";
    let activeVibe = "all";

    $(document).ready(function() {
        // Handle Deep Linking for Search
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');
        if (searchParam) { $("#musicSearch").val(searchParam); }

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                fullCatalog = results.data;
                renderVault();
            }
        });

        // Listeners
        $("#musicSearch").on("input", renderVault);
        
        $("#scoreSlider").on("input", function() {
            activeThreshold = $(this).val();
            $("#scoreVal").text(activeThreshold);
            renderVault();
        });

        $(".type-option").on("click", function() {
            $(".type-option").removeClass("active");
            $(this).addClass("active");
            activeType = $(this).data("type");
            renderVault();
        });

        $(".chip").on("click", function() {
            $(".chip").removeClass("active");
            $(this).addClass("active");
            activeVibe = $(this).data("vibe");
            renderVault();
        });
    });

    function renderVault() {
        const body = $('#vaultBody');
        body.empty();
        let html = "";
        let count = 0;
        let filter = ($("#musicSearch").val() || "").toString().toLowerCase().trim();

        // Sort by Performance Quality (10 down to 1)
        let sortedCatalog = [...fullCatalog].sort((a, b) => {
            return (parseInt(b["PerformanceQuality"]) || 0) - (parseInt(a["PerformanceQuality"]) || 0);
        });

        sortedCatalog.forEach(row => {
            let title = (row["SongTitle"] || "").toString().trim();
            let artist = (row["Artist"] || "Various").toString().trim();
            let rn = (row["RouteNote"] || "").toString().trim().toLowerCase();
            
            // Validation: Skip rows without titles or marked NO in RouteNote
            if (!title || rn === 'no') return;

            // Score Filter
            let score = parseInt(row["PerformanceQuality"]) || 0;
            if (score < activeThreshold) return;

            // Type Logic (Enhanced for Inst. Available)
            let type = (row["Type"] || "").toString().toLowerCase();
            let remixAvail = (row["Remix Available"] || "").toString().trim() === "Yes";
            
            if (activeType === "vocal" && !type.includes("vocal")) return;
            if (activeType === "instrumental" && !type.includes("instrumental")) return;
            // NEW LOGIC: "Remix" filter shows actual instrumentals OR tracks with available remixes
            if (activeType === "remix" && !type.includes("instrumental") && !remixAvail) return;

            // Vibe Filter
            let vCat = (row["VibeCategory"] || "").toString().trim();
            if (activeVibe !== "all" && vCat !== activeVibe) return;

            // Search Filter
            let vibe = (row["Vibe"] || "").toString().trim();
            let searchStr = (title + " " + artist + " " + vCat + " " + vibe).toLowerCase();
            if (filter && !searchStr.includes(filter)) return;

            count++;
            
            // Build Row
            let osBadge = '<span class="badge-os">ONE-STOP</span>';
            let remixBadge = remixAvail ? '<span class="badge-remix">REMIX READY</span>' : "";
            let combinedVibe = (vCat && vibe) ? vCat + " - " + vibe : (vCat || vibe);
            let tags = [row["Genre1"], row["Mood"]].filter(Boolean).join(", ");
            let recType = (row["Recording Type"] || "").toString().trim();

            html += `<tr>
                <td><strong>${title}</strong>${remixBadge}${osBadge}</td>
                <td>${artist}</td>
                <td class="tag-text">
                    <span class="vibe-label">${combinedVibe}</span><br>
                    ${tags}<br>
                    <span class="meta-label">Format: ${recType} | Quality: ${score}/10</span>
                </td>
                <td><button class="play-btn" onclick="openPlayer('${title.replace(/'/g, "\\'")}', '${artist.replace(/'/g, "\\'")}')">PLAY</button></td>
            </tr>`;
        });

        $('#resultCount').text(count + " tracks found (Quality " + activeThreshold + "+)");
        if (html === "") html = '<tr><td colspan="4" style="text-align:center; padding:50px; color:#666;">No tracks match your current filters. Try lowering the "Min Score" or checking "All Vibes."</td></tr>';
        body.append(html);
    }

    function openPlayer(title, artist) {
        $("#nowPlaying").text(title + " - " + artist);
        // Add your streaming source logic here. If you use a specific folder:
        // $("#audioPlayer").attr("src", "/audio/" + title + ".mp3");
        $("#playerBar").css("display", "flex");
    }
</script>

</body>
</html>
